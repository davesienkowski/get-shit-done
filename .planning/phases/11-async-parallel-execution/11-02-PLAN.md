---
phase: 11-intelligent-parallel-execution
plan: 02
type: execute
---

<objective>
Integrate task-level parallelization into execute-phase workflow for individual plan execution.

Purpose: When executing a single plan with multiple tasks, automatically detect independent tasks and spawn parallel agents for task groups. Merge results back for SUMMARY generation.
Output: Enhanced execute-phase.md workflow with task dependency analysis, parallel task execution, and result merging.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 11-01 provides plan-level parallelization:
@.planning/phases/11-async-parallel-execution/11-01-SUMMARY.md

# Key files to modify:
@get-shit-done/workflows/execute-phase.md
@get-shit-done/templates/agent-history.md
@commands/gsd/status.md

**Tech stack available:** Task tool with run_in_background parameter, TaskOutput tool for completion detection
**Established patterns:** Task parsing from PLAN.md, file conflict detection from 11-01, checkpoint skip config
**Constraining decisions:**
- 11-01: Dependency detection using frontmatter and file conflicts
- 11-01: Completion monitoring with TaskOutput polling
- 11-01: Checkpoint skip opt-out via config (skip_checkpoints: false)
- 11-01: Orchestrator holds commits until all complete
- 11-01: max_concurrent_agents is global limit (task agents count toward it)
- User requirement: Parallelize tasks within plans when safe
- User requirement: Checkpoint tasks can parallelize with opt-out config
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add task dependency analysis with checkpoint detection</name>
  <files>get-shit-done/workflows/execute-phase.md</files>
  <action>
    Add logic within the execute step to analyze task dependencies before execution:

    **Step: analyze_task_dependencies** (within plan execution)

    1. **Parse all tasks from the PLAN.md:**
       - Extract `<task>` elements
       - Note `<files>` elements within each task
       - Note any `depends_on` attributes (if present)
       - Detect checkpoint tasks: `type="checkpoint"` or `<checkpoint>` elements

    2. **Build task dependency graph:**
       ```
       Task dependencies detected by:
       a) Explicit depends_on attribute: <task depends_on="task-1">
       b) File conflicts: Tasks modifying same files must be sequential
       c) Output references: Task B references output of Task A
       d) Sequential logic: Task describes "after X is done" or "using output from"
       e) Checkpoint position: Checkpoint tasks break parallelization flow
       ```

    3. **Categorize tasks:**
       - `independent`: Can run in parallel (no shared files, no dependencies)
       - `dependent`: Must wait for specific tasks
       - `checkpoint`: Contains human interaction (human-verify, decision, human-action)

    4. **Checkpoint handling at task level:**
       - By default, checkpoint tasks ARE included in parallelization groups
       - In background task agents, checkpoints are handled as:
         - `checkpoint:human-verify`: Skip and log "skipped - background mode"
         - `checkpoint:decision`: Use first option and log choice
         - `checkpoint:human-action`: Skip and log warning
       - If config `skip_checkpoints: false`, tasks containing checkpoints run in main context (foreground)
       - Checkpoint tasks create dependency barriers: tasks after a checkpoint depend on it

    5. **Group independent tasks (respecting checkpoints):**
       ```
       Example for a 6-task plan with checkpoint at Task 4:

       If skip_checkpoints: true (default):
         Group 1: [Task 1, Task 3] - no dependencies, no file conflicts
         Sequential: Task 2 (depends on Task 1 output)
         Group 2: [Task 4-checkpoint, Task 5] - can parallelize (checkpoint skipped)
         Sequential: Task 6 (depends on Task 5)

       If skip_checkpoints: false:
         Group 1: [Task 1, Task 3] - parallel
         Sequential: Task 2 (depends on Task 1)
         Main Context: Task 4 (checkpoint - must run in foreground)
         Group 2: [Task 5] - after checkpoint
         Sequential: Task 6
       ```

    6. **Decision logic:**
       - If only 1-2 tasks total: execute sequentially (overhead not worth it)
       - If config.parallelization.task_level = false: execute sequentially
       - If plan frontmatter has `parallel_tasks: false`: execute sequentially
       - If fewer than min_tasks_for_parallel: execute sequentially
       - If no independent groups after analysis: execute sequentially
       - Otherwise: spawn parallel agents per group
  </action>
  <verify>execute-phase.md analyzes tasks with checkpoint detection and grouping</verify>
  <done>Task dependency analysis identifies independent groups respecting checkpoints</done>
</task>

<task type="auto">
  <name>Task 2: Add task-level parallel spawning with concurrency management</name>
  <files>get-shit-done/workflows/execute-phase.md</files>
  <action>
    Add spawning logic for parallel task execution:

    **Step: spawn_task_agents**
    When analyze_task_dependencies finds independent task groups:

    **Concurrency management:**
    - Task agents share the global `max_concurrent_agents` limit from config
    - If plan-level parallelization is also active, task agents count toward the same pool
    - Example: max_concurrent=3, 2 plan agents running → only 1 task agent slot available
    - Check available slots before spawning: `available = max_concurrent - currently_running`

    1. **For each independent task group (respecting concurrency):**
       ```
       Task(
         description: "Execute tasks {task-ids} from plan {plan}",
         prompt: "Execute ONLY these tasks from plan at {path}: [task list]

                  DO NOT execute other tasks.
                  DO NOT create SUMMARY.md (orchestrator will merge results).
                  DO NOT commit changes (orchestrator handles commits).

                  For any checkpoints encountered:
                  - human-verify: Log 'skipped - background mode' and continue
                  - decision: Use first option and log choice
                  - human-action: Log 'skipped - background mode' and continue

                  Report back:
                  - Files modified (list paths)
                  - Task outcomes (success/failure per task)
                  - Deviations encountered
                  - Checkpoints skipped (if any)",
         subagent_type: "general-purpose",
         run_in_background: true
       )
       ```

    2. **Track task-level agents with unique identifiers:**
       - Generate task_parallel_group ID (e.g., "plan-11-02-tasks-batch-1")
       - Record which specific tasks each agent is executing
       - Agent-history entry includes `granularity: "task_group"`

    3. **Report spawn status:**
       ```
       Plan 11-02 has 6 tasks, spawning parallel execution:

       Concurrent slots: 2 available (of 3 max)

       Parallel Group 1 (starting now):
         → Tasks 1, 3: agent_01HXXX

       Sequential (after Group 1):
         → Task 2: waiting for Task 1

       Parallel Group 2 (after Task 2):
         → Tasks 4, 5: queued
         → Task 4 has checkpoint (will be skipped in background)

       Sequential (main context):
         → Task 6: depends on Task 5
       ```

    4. **Handle slot exhaustion:**
       - If no concurrent slots available, queue all task groups
       - Poll for available slots during completion monitoring
       - Spawn queued groups as slots become available
  </action>
  <verify>execute-phase.md spawns task agents respecting global concurrency limit</verify>
  <done>Task-level parallel spawning with shared concurrency pool</done>
</task>

<task type="auto">
  <name>Task 3: Add task result merging for SUMMARY</name>
  <files>get-shit-done/workflows/execute-phase.md</files>
  <action>
    Add result aggregation after parallel task completion:

    **Step: merge_task_results**
    When all task agents complete:

    1. **Collect results from each agent:**
       - Files created/modified (from agent output)
       - Task outcomes (success/failure per task)
       - Deviations encountered
       - Checkpoints skipped (count and details)

    2. **Merge into unified execution record:**
       ```
       Task Results:
       - Task 1: Complete (agent_01HXXX) - 3 files, 0 deviations
       - Task 2: Complete (main) - 1 file, 1 deviation
       - Task 3: Complete (agent_01HXXX) - 2 files, 0 deviations
       - Task 4: Complete (agent_01HYYY) - 1 file, checkpoint skipped
       - Task 5: Complete (agent_01HYYY) - 2 files, 0 deviations
       - Task 6: Complete (main) - 1 file, 0 deviations
       ```

    3. **Handle merge conflicts:**
       - If two agents modified same file unexpectedly: flag for review
       - Present conflict to user with diff options:
         ```
         ⚠️ File conflict detected: src/config.ts

         Modified by:
         - Task 1 (agent_01HXXX): lines 10-25
         - Task 3 (agent_01HXXX): lines 45-60

         Options:
         1. Review diff and merge manually
         2. Keep Task 1 changes only
         3. Keep Task 3 changes only
         4. Keep both (may have issues)
         ```
       - Allow manual resolution before continuing

    4. **Generate unified SUMMARY.md:**
       - Aggregate all accomplishments from all tasks
       - Merge all file lists (deduplicate)
       - Combine all deviations
       - List checkpoints skipped (if any)
       - Include parallelization stats:
         ```markdown
         ## Execution Stats
         - Total tasks: 6
         - Parallel groups: 2 (4 tasks parallelized)
         - Sequential tasks: 2
         - Checkpoints skipped: 1 (Task 4: human-verify)
         - Total time: 4m 12s
         - Sequential estimate: 8m 30s
         - Speedup: 2x
         ```

    5. **Commit handling (deferred to orchestrator):**
       - Task agents do NOT commit
       - After SUMMARY generated, orchestrator stages all files
       - Single plan commit created:
         ```
         git add [all files from all tasks]
         git commit -m "feat({phase}-{plan}): {description}"
         ```
  </action>
  <verify>execute-phase.md merges parallel task results with conflict handling</verify>
  <done>Result merging produces correct SUMMARY with checkpoint and conflict handling</done>
</task>

<task type="auto">
  <name>Task 4: Add task parallelization config options</name>
  <files>get-shit-done/workflows/execute-phase.md</files>
  <action>
    Add configuration for task-level parallelization (extends 11-01 config):

    **Config schema (in config.json) - extending 11-01:**
    ```json
    {
      "mode": "yolo",
      "parallelization": {
        "plan_level": true,
        "task_level": true,
        "skip_checkpoints": true,
        "max_concurrent_agents": 3,
        "min_plans_for_parallel": 2,
        "min_tasks_for_parallel": 3
      }
    }
    ```

    **Task-level specific options:**
    - `task_level`: Enable/disable task-level parallelization (default: true)
    - `min_tasks_for_parallel`: Minimum tasks in a plan to consider parallelizing (default: 3)
    - `skip_checkpoints`: Affects both plan and task level (default: true)

    **Per-plan override in PLAN.md frontmatter:**
    ```yaml
    ---
    phase: 11
    plan: 02
    parallel_tasks: false  # Disable task parallelization for this plan only
    skip_checkpoints: false  # Force foreground for checkpoint tasks
    ---
    ```

    **Per-task override (new):**
    ```xml
    <task type="auto" parallel="false">
      <!-- This task must run sequentially even if no file conflicts -->
    </task>

    <task type="checkpoint" skip_in_background="false">
      <!-- This checkpoint must run in foreground even if skip_checkpoints: true globally -->
    </task>
    ```

    **Decision tree:**
    1. Config says task_level: false → all tasks sequential
    2. Plan frontmatter says parallel_tasks: false → all tasks sequential
    3. Fewer than min_tasks_for_parallel → sequential
    4. Task has parallel="false" attribute → that task runs sequentially
    5. Checkpoint task with skip_in_background="false" → runs in foreground
    6. Otherwise → analyze dependencies and parallelize where safe
  </action>
  <verify>execute-phase.md respects task-level config at all levels</verify>
  <done>Task parallelization configurable globally, per-plan, and per-task</done>
</task>

<task type="auto">
  <name>Task 5: Update agent-history for task-level tracking</name>
  <files>get-shit-done/templates/agent-history.md</files>
  <action>
    Extend agent-history schema for task-level parallelization (adds to 11-01 schema):

    **New fields for task-level:**
    - `granularity`: "plan" | "task_group" - whether agent executed full plan or task subset
    - `task_group`: string[] | null - array of task names/numbers this agent executed
    - `task_results`: object | null - per-task outcomes when granularity is "task_group"

    **Example entry for task-level execution:**
    ```json
    {
      "agent_id": "agent_01HXXX",
      "task_description": "Execute tasks 1,3 from plan 11-02",
      "phase": "11",
      "plan": "02",
      "segment": null,
      "timestamp": "2026-01-10T08:05:00Z",
      "status": "completed",
      "completion_timestamp": "2026-01-10T08:06:45Z",
      "execution_mode": "parallel",
      "output_file": "/tmp/agent_01HXXX.output",
      "background_status": "completed",
      "parallel_group": "plan-11-02-tasks-batch-1",
      "granularity": "task_group",
      "task_group": ["Task 1", "Task 3"],
      "depends_on": null,
      "checkpoints_skipped": 0,
      "files_modified": ["src/auth.ts", "src/types.ts", "src/utils.ts"],
      "task_results": {
        "Task 1": {
          "status": "completed",
          "files": ["src/auth.ts"],
          "deviations": []
        },
        "Task 3": {
          "status": "completed",
          "files": ["src/types.ts", "src/utils.ts"],
          "deviations": []
        }
      }
    }
    ```

    **Distinguish from plan-level entries:**
    - Plan-level: `granularity: "plan"`, `task_group: null`
    - Task-level: `granularity: "task_group"`, `task_group: ["Task 1", ...]`
  </action>
  <verify>agent-history.md documents granularity, task_group, and task_results fields</verify>
  <done>Agent history distinguishes plan-level from task-level execution</done>
</task>

<task type="auto">
  <name>Task 6: Update /gsd:status for task-level display</name>
  <files>commands/gsd/status.md</files>
  <action>
    Enhance status command to show task-level parallel execution:

    **Display format when task parallelization is active:**
    ```
    Plan Execution: 11-02-PLAN.md
    ════════════════════════════════════

    Task Parallel Execution Active
    Concurrency: 2/3 slots in use

    Group 1 (Running):
      → Tasks 1, 3: agent_01HXXX (45s elapsed)

    Sequential (Waiting):
      ⏳ Task 2: waiting for Task 1

    Group 2 (Queued):
      ⏳ Tasks 4, 5: waiting for Task 2
      ⚠️ Task 4 checkpoint will be skipped

    Sequential (After Group 2):
      ⏳ Task 6: depends on Task 5

    ════════════════════════════════════
    Progress: 0/6 tasks complete
    Parallelization: 2 groups (4 tasks parallelized)
    Checkpoints: 1 will be skipped
    ```

    **When plan-level and task-level both active:**
    ```
    Phase 11 Parallel Execution
    ════════════════════════════════════
    Concurrency: 3/3 slots in use

    Plan-Level:
      → 11-01: Running
        └─ Tasks 1,3: parallel (agent_01HAAA)
        └─ Task 2: sequential
      → 11-03: Running (all tasks sequential)
      ⏳ 11-02: Queued (waiting for 11-01)

    ════════════════════════════════════
    Plans: 1/3 complete
    Active agents: 3 (2 plan-level, 1 task-level)
    ```

    **Nested concurrency display:**
    - Show which agents are plan-level vs task-level
    - Show nested task progress within each plan
    - Indicate checkpoint skips at both levels
  </action>
  <verify>status.md shows nested plan/task parallel execution</verify>
  <done>Status command displays both plan and task level with nesting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] execute-phase.md has analyze_task_dependencies with checkpoint detection
- [ ] execute-phase.md spawns task agents respecting global concurrency
- [ ] execute-phase.md merges task results with conflict handling
- [ ] Config options documented at global, plan, and task levels
- [ ] agent-history.md has granularity, task_group, and task_results fields
- [ ] status.md shows nested plan/task parallel execution
</verification>

<success_criteria>
- Single plan execution automatically parallelizes independent tasks
- Task dependency detection uses file conflicts, explicit deps, and checkpoint positions
- Checkpoint tasks can parallelize with skipping (configurable opt-out at task level)
- Task agents share global concurrency pool with plan agents
- Result merging handles conflicts and produces correct unified SUMMARY
- /gsd:status shows nested parallel execution at both levels
</success_criteria>

<output>
After completion, create `.planning/phases/11-async-parallel-execution/11-02-SUMMARY.md`:

# Phase 11 Plan 02: Task-Level Parallelization Summary

**[Substantive one-liner describing what shipped]**

## Accomplishments
- Added task dependency analysis with checkpoint detection
- Implemented parallel task group spawning with shared concurrency pool
- Added result merging with conflict detection and resolution
- Added task parallelization config at global, plan, and task levels
- Extended agent-history for task-level tracking (granularity, task_results)
- Enhanced /gsd:status for nested plan/task parallel display

## Files Created/Modified
- `get-shit-done/workflows/execute-phase.md` - Task-level parallelization
- `get-shit-done/templates/agent-history.md` - Task group tracking fields
- `commands/gsd/status.md` - Nested parallel execution display

## Decisions Made
- Task agents share global max_concurrent_agents pool with plan agents
- Checkpoint tasks can parallelize with skip_in_background opt-out per task
- Conflict detection at file level with user resolution options
- Task-level commits deferred to orchestrator (single plan commit)

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
Phase 11 complete - milestone ready for completion
</output>
